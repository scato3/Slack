(self.webpackChunkalecture=self.webpackChunkalecture||[]).push([[94],{3094:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>v});var n=a(2309),r=a(2545),l=a(8678),s=a(2951),o=a(7753);const c=(0,o.Z)("div",{target:"enpw7kx2"})({name:"1a0r0eh",styles:"display:flex;flex-wrap:wrap;height:calc(100vh - 38px);flex-flow:column;position:relative"}),i=(0,o.Z)("header",{target:"enpw7kx1"})({name:"1c17pcy",styles:"height:64px;display:flex;width:100%;--saf-0:rgba(var(--sk_foreground_low, 29, 28, 29), 0.13);box-shadow:0 1px 0 var(--saf-0);padding:20px 16px 20px 20px;font-weight:bold;align-items:center;& img{margin-right:5px;}"}),p=(0,o.Z)("div",{target:"enpw7kx0"})({name:"czjct4",styles:"position:absolute;top:64px;left:0;width:100%;height:calc(100% - 64px);background:white;opacity:0.7;display:flex;align-items:center;justify-content:center;font-size:40px"});var d=a(3564),u=a(8667),f=a(9669),m=a.n(f),g=a(7294),h=a(6182),k=a.n(h),w=a(5977),x=a(8100);const v=()=>{const{workspace:e,id:t}=(0,w.UO)(),{data:a}=(0,x.ZP)(`/api/workspaces/${e}/users/${t}`,d.Z),{data:o}=(0,x.ZP)("/api/users",d.Z),[f,h,v]=(0,l.Z)(""),{data:b,mutate:T,revalidate:Z,setSize:E}=(0,x.g_)((a=>`/api/workspaces/${e}/dms/${t}/chats?perPage=20&page=${a+1}`),d.Z),[S]=(0,s.Z)(e),y=0===b?.[0]?.length||b&&b[b.length-1]?.length<20||!1,C=(0,g.useRef)(null),[$,D]=(0,g.useState)(!1),z=(0,g.useCallback)((n=>{if(n.preventDefault(),console.log(f),f?.trim()&&b){const n=f;T((e=>(e?.[0].unshift({id:(b[0][0]?.id||0)+1,content:n,SenderId:o.id,Sender:o,ReceiverId:a.id,Receiver:a,createdAt:new Date}),e)),!1).then((()=>{v(""),C.current?.scrollToBottom()})),m().post(`/api/workspaces/${e}/dms/${t}/chats`,{content:f}).then((()=>{Z()})).catch(console.error)}}),[f,b,o,a,e,t]),B=(0,g.useCallback)((e=>{e.SenderId===Number(t)&&o.id!==Number(t)&&T((t=>(t?.[0].unshift(e),t)),!1).then((()=>{C.current&&C.current.getScrollHeight()<C.current.getClientHeight()+C.current.getScrollTop()+150&&(console.log("scrollToBottom!",C.current?.getValues()),setTimeout((()=>{C.current?.scrollToBottom()}),50))}))}),[]);(0,g.useEffect)((()=>(S?.on("dm",B),()=>{S?.off("dm",B)})),[S,B]),(0,g.useEffect)((()=>{1===b?.length&&setTimeout((()=>{C.current?.scrollToBottom()}),100)}),[b]);const R=(0,g.useCallback)((a=>{a.preventDefault(),console.log(a);const n=new FormData;if(a.dataTransfer.items){for(let e=0;e<a.dataTransfer.items.length;e++)if("file"===a.dataTransfer.items[e].kind){const t=a.dataTransfer.items[e].getAsFile();console.log("... file["+e+"].name = "+t.name),n.append("image",t)}}else for(let e=0;e<a.dataTransfer.files.length;e++)console.log("... file["+e+"].name = "+a.dataTransfer.files[e].name),n.append("image",a.dataTransfer.files[e]);m().post(`/api/workspaces/${e}/dms/${t}/images`,n).then((()=>{D(!1),Z()}))}),[Z,e,t]),F=(0,g.useCallback)((e=>{e.preventDefault(),console.log(e),D(!0)}),[]);if(!a||!o)return null;const I=(0,u.Z)(b?b.flat().reverse():[]);return g.createElement(c,{onDrop:R,onDragOver:F},g.createElement(i,null,g.createElement("img",{src:k().url(a.email,{s:"24px",d:"retro"}),alt:a.nickname}),g.createElement("span",null,a.nickname)),g.createElement(r.Z,{chatSections:I,ref:C,setSize:E,isReachingEnd:y}),g.createElement(n.Z,{chat:f,onChangeChat:h,onSubmitForm:z}),$&&g.createElement(p,null,"업로드!"))}}}]);